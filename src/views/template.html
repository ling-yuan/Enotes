<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Note Editor</title>
        <meta name="description" content="ä¸€ä¸ªç®€å•çš„Markdownç¬”è®°ç¼–è¾‘å™¨">
        <meta name="keywords" content="ç¬”è®°, Markdown, ç¼–è¾‘å™¨">
        <!--localfile-->
        <style>
            :root {
                --vscode-editor-background: var(--vscode-editor-background);
                --vscode-editor-foreground: var(--vscode-editor-foreground);
                --tag-bg-color: var(--vscode-badge-background);
                --tag-fg-color: var(--vscode-badge-foreground);
                /* æ·»åŠ è¡Œå·ç›¸å…³çš„ä¸»é¢˜å˜é‡ */
                --line-number-color: var(--vscode-editorLineNumber-foreground);
                --line-number-active-color: var(--vscode-editorLineNumber-activeForeground);
                --line-number-gutter-background: var(--vscode-editorGutter-background);
                --line-number-gutter-active-background: var(--vscode-editorGutter-activeBackground);
            }

            body {
                padding: 0;
                margin: 0;
                width: 100%;
                height: 100vh;
                background-color: var(--vscode-editor-background);
                color: var(--vscode-editor-foreground);
                font-family: var(--vscode-editor-font-family);
                font-size: var(--vscode-editor-font-size);
                display: flex;
                flex-direction: column;
            }

            #tags-container {
                padding: 10px;
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                border-bottom: 1px solid var(--vscode-panel-border);
                min-height: 24px;
                align-items: center;
                position: relative;
            }

            .tag {
                background-color: var(--tag-bg-color);
                color: var(--tag-fg-color);
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 12px;
                display: inline-flex;
                align-items: center;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            .tag:hover {
                background-color: var(--vscode-button-hoverBackground);
            }

            .no-tags-hint {
                color: var(--vscode-descriptionForeground);
                font-style: italic;
                font-size: 12px;
                opacity: 0.8;
                cursor: pointer;
            }

            .no-tags-hint:hover {
                text-decoration: underline;
            }

            #editor-container {
                flex: 1;
                overflow: hidden;
            }

            .CodeMirror {
                height: 100% !important;
                width: 100%;
                background-color: var(--vscode-editor-background) !important;
                color: var(--vscode-editor-foreground) !important;
                font-family: var(--vscode-editor-font-family) !important;
                font-size: var(--vscode-editor-font-size) !important;
                line-height: 1.5;
            }

            /* è¡Œå·å®¹å™¨æ ·å¼ */
            .CodeMirror-gutters {
                background-color: var(--line-number-gutter-background) !important;
                border-right: 1px solid var(--vscode-panel-border) !important;
            }

            /* è¡Œå·æ ·å¼ */
            .CodeMirror-linenumbers {
                padding: 0 8px;
            }

            .CodeMirror-linenumber {
                color: var(--line-number-color) !important;
                font-size: var(--vscode-editor-font-size) !important;
                padding: 0 3px 0 5px !important;
            }

            /* æ·»åŠ æ–‡æœ¬å†…å®¹ä¸è¡Œå·ä¹‹é—´çš„é—´è· */
            .CodeMirror-lines {
                padding-left: 8px !important;
            }

            .CodeMirror-line {
                padding-left: 4px !important;
            }

            /* å½“å‰è¡Œçš„è¡Œå·å’ŒèƒŒæ™¯é«˜äº® */
            .CodeMirror-activeline-gutter {
                background-color: var(--line-number-gutter-active-background) !important;
            }

            .CodeMirror-activeline-gutter .CodeMirror-linenumber {
                color: var(--line-number-active-color) !important;
                font-weight: bold;
            }

            /* å…‰æ ‡æ ·å¼ */
            .CodeMirror-cursor {
                border-left: 2px solid var(--vscode-editorCursor-foreground) !important;
                border-right: none;
                width: 0;
            }

            /* é€‰ä¸­æ–‡æœ¬çš„èƒŒæ™¯è‰² */
            .CodeMirror-selected {
                background: var(--vscode-editor-selectionBackground) !important;
            }

            /* å…‰æ ‡æ‰€åœ¨è¡Œé«˜äº® */
            .CodeMirror-activeline-background {
                background: var(--vscode-editor-lineHighlightBackground) !important;
            }

            /* Markdown è¯­æ³•é«˜äº® */
            .cm-header {
                color: var(--vscode-symbolIcon-classForeground) !important;
            }

            .cm-strong {
                color: var(--vscode-symbolIcon-constantForeground) !important;
            }

            .cm-em {
                color: var(--vscode-symbolIcon-propertyForeground) !important;
            }

            .cm-link {
                color: var(--vscode-textLink-foreground) !important;
            }

            .cm-url {
                color: var(--vscode-textLink-activeForeground) !important;
            }

            .cm-quote {
                color: var(--vscode-textPreformat-foreground) !important;
            }

            .cm-variable-2 {
                color: var(--vscode-symbolIcon-variableForeground) !important;
            }

            .cm-variable-3 {
                color: var(--vscode-symbolIcon-functionForeground) !important;
            }

            .cm-keyword {
                color: var(--vscode-symbolIcon-keywordForeground) !important;
            }

            .cm-comment {
                color: var(--vscode-editorLineNumber-foreground) !important;
            }

            #preview-container {
                display: none;
                padding: 20px;
                height: 100%;
                overflow: auto;
            }

            /* æ·»åŠ åˆ‡æ¢æŒ‰é’®æ ·å¼ */
            #toggle-button {
                position: fixed;
                top: 10px;
                right: 10px;
                padding: 6px 10px;
                background-color: var(--vscode-button-background);
                color: var(--vscode-button-foreground);
                border: none;
                border-radius: 3px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 5px;
                z-index: 1000;
            }

            #toggle-button:hover {
                background-color: var(--vscode-button-hoverBackground);
            }

            #toggle-button:active {
                background-color: var(--vscode-button-pressedBackground);
            }

            /* æ·»åŠ å›¾æ ‡æ ·å¼ */
            .icon {
                width: 16px;
                height: 16px;
                display: inline-block;
                margin-right: 4px;
            }

            .preview-icon::before {
                content: "ğŸ‘";
            }

            .edit-icon::before {
                content: "âœï¸";
            }

            /* æ·»åŠ æ ‡ç­¾ç¼–è¾‘æŒ‰é’®æ ·å¼ */
            .edit-tags-button {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background-color: transparent;
                border: none;
                color: var(--vscode-foreground);
                cursor: pointer;
                display: flex;
                align-items: center;
                padding: 4px 8px;
                border-radius: 3px;
                font-size: 12px;
            }

            .edit-tags-button:hover {
                background-color: var(--vscode-button-hoverBackground);
            }

            .edit-tags-button::before {
                content: "âœï¸";
                margin-right: 4px;
                font-size: 14px;
            }
        </style>
    </head>

    <body>
        <div id="tags-container"></div>
        <div id="editor-container"></div>
        <div id="preview-container" class="markdown-body"></div>

        <script>
            const vscode = acquireVsCodeApi();
            let editor;
            let noteTitle = "";
            let lastContent = '';
            let saveTimeout = null;
            let isPreviewMode = false;

            // åˆå§‹åŒ–ç¼–è¾‘å™¨
            function initEditor() {
                editor = CodeMirror(document.getElementById('editor-container'), {
                    mode: 'markdown',
                    theme: 'vscode-dark',
                    lineWrapping: true,
                    lineNumbers: true,         // å¯ç”¨è¡Œå·æ˜¾ç¤º
                    scrollbarStyle: null,
                    viewportMargin: Infinity,
                    styleActiveLine: true,     // å¯ç”¨å½“å‰è¡Œé«˜äº®
                    styleActiveLineGutter: true, // å¯ç”¨å½“å‰è¡Œè¡Œå·é«˜äº®
                    cursorHeight: 1,           // è®¾ç½®å…‰æ ‡é«˜åº¦ä¸ºè¡Œé«˜
                    cursorBlinkRate: 530,      // è®¾ç½®å…‰æ ‡é—ªçƒé€Ÿåº¦ï¼Œä¸VS Codeä¿æŒä¸€è‡´
                    extraKeys: {
                        'Tab': function (cm) {
                            cm.replaceSelection('    ');
                        }
                    }
                });

                // ç›‘å¬ç¼–è¾‘å™¨å˜åŒ–
                editor.on('change', () => {
                    const content = editor.getValue();
                    if (content !== lastContent) {
                        if (saveTimeout) {
                            clearTimeout(saveTimeout);
                        }
                        saveTimeout = setTimeout(() => {
                            lastContent = content;
                            vscode.postMessage({
                                type: 'save',
                                noteTitle: noteTitle,
                                content: content
                            });
                        }, 500);
                    }
                });
            }

            // åˆ‡æ¢é¢„è§ˆ/ç¼–è¾‘æ¨¡å¼
            function togglePreview() {
                isPreviewMode = !isPreviewMode;
                const editorContainer = document.getElementById('editor-container');
                const previewContainer = document.getElementById('preview-container');

                if (isPreviewMode) {
                    // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
                    editorContainer.style.display = 'none';
                    previewContainer.style.display = 'block';
                    // è·å–å½“å‰å†…å®¹å¹¶è½¬æ¢ä¸ºHTML
                    const content = editor.getValue();
                    vscode.postMessage({
                        type: 'getPreview',
                        content: content
                    });
                } else {
                    // åˆ‡æ¢å›ç¼–è¾‘æ¨¡å¼
                    editorContainer.style.display = 'block';
                    previewContainer.style.display = 'none';
                    // åˆ·æ–°ç¼–è¾‘å™¨ä»¥ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
                    editor.refresh();
                }
            }

            // æ›´æ–°é¢„è§ˆå†…å®¹
            function updatePreview(html) {
                const previewContainer = document.getElementById('preview-container');
                previewContainer.innerHTML = html;
            }

            // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
            function updateTags(tags) {
                const container = document.getElementById('tags-container');
                container.innerHTML = '';

                // æ·»åŠ ç¼–è¾‘æ ‡ç­¾æŒ‰é’®
                const editButton = document.createElement('button');
                editButton.className = 'edit-tags-button';
                editButton.textContent = 'ç¼–è¾‘æ ‡ç­¾';
                editButton.addEventListener('click', () => {
                    vscode.postMessage({
                        type: 'editTags',
                        noteTitle: noteTitle
                    });
                });
                container.appendChild(editButton);

                if (!tags || tags.length === 0) {
                    const noTagsHint = document.createElement('div');
                    noTagsHint.className = 'no-tags-hint';
                    noTagsHint.textContent = 'æš‚æ— æ ‡ç­¾';
                    // ä¸º"æš‚æ— æ ‡ç­¾"æç¤ºæ·»åŠ ç‚¹å‡»äº‹ä»¶
                    noTagsHint.addEventListener('click', () => {
                        vscode.postMessage({
                            type: 'editTags',
                            noteTitle: noteTitle
                        });
                    });
                    container.appendChild(noTagsHint);
                    return;
                }

                tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.textContent = tag;
                    // ä¸ºæ¯ä¸ªæ ‡ç­¾æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    tagElement.addEventListener('click', () => {
                        vscode.postMessage({
                            type: 'editTags',
                            noteTitle: noteTitle
                        });
                    });
                    container.appendChild(tagElement);
                });
            }

            // æ¥æ”¶æ¥è‡ªæ‰©å±•çš„æ¶ˆæ¯
            window.addEventListener('message', event => {
                const message = event.data;
                switch (message.type) {
                    case 'update':
                        if (!editor) {
                            initEditor();
                        }
                        // åªæœ‰åœ¨ä¸ä¿æŒå†…å®¹çš„æƒ…å†µä¸‹æ‰æ›´æ–°ç¼–è¾‘å™¨å†…å®¹
                        if (!message.keepContent && message.content !== undefined) {
                            editor.setValue(message.content);
                            lastContent = message.content;
                        }
                        if (message.noteTitle) {
                            noteTitle = message.noteTitle;
                        }
                        // å¦‚æœæœ‰æ ‡ç­¾ä¿¡æ¯ï¼Œåˆ™æ›´æ–°æ ‡ç­¾
                        if (message.tags) {
                            updateTags(message.tags);
                        }
                        break;
                    case 'preview':
                        updatePreview(message.html);
                        break;
                    case 'togglePreview':
                        togglePreview();
                        break;
                }
            });
        </script>
    </body>

</html>